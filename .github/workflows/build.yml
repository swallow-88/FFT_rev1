name: Build FFTApp APK

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash -eux {0}

    steps:
      # 1) 소스 코드 체크아웃
      - uses: actions/checkout@v3

      # 2) Python 환경 설정
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3) 필수 시스템 패키지 및 빌드 도구 설치
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jdk build-essential zip unzip \
            libffi-dev libssl-dev python3-dev
          python -m pip install --upgrade pip
          pip install cython
          # Buildozer / p4a 고정 버전 설치
          pip install buildozer==1.5.0 python-for-android==2023.9.16

      # 4) Android SDK command-line tools 설치 및 구성
      - name: Install Android SDK & NDK
        run: |
          SDK=$HOME/android-sdk
          mkdir -p $SDK/cmdline-tools && cd $SDK/cmdline-tools
          curl -fSLo tools.zip \
            https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q tools.zip && mv cmdline-tools latest
          export PATH=$SDK/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --sdk_root=$SDK --licenses
          sdkmanager --sdk_root=$SDK \
            "platform-tools" \
            "platforms;android-31" \
            "build-tools;31.0.0" \
            "ndk;25.2.9519653"

      # 5) buildozer.spec 에 외부 SDK/NDK 경로 주입
      - name: Configure buildozer.spec
        run: |
          sed -i '/^android\.sdk_path/d' buildozer.spec || true
          sed -i '/^android\.ndk_path/d' buildozer.spec || true
          echo "android.sdk_path = $HOME/android-sdk"          >> buildozer.spec
          echo "android.ndk_path = $HOME/android-sdk/ndk/25.2.9519653" >> buildozer.spec
          echo "android.build_tools_version = 31.0.0"           >> buildozer.spec

      # 6) APK 빌드
      - name: Build APK with Buildozer
        run: |
          # clean 옵션으로 캐시 완전 삭제 후 빌드
          buildozer android clean
          buildozer android debug --verbose

      # 7) 생성된 APK 업로드
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: fftapp-apk
          path: bin/*.apk
